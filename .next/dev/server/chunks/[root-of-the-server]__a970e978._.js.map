{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 64, "column": 0}, "map": {"version":3,"sources":["file:///F:/SnapEdge/src/lib/db.ts"],"sourcesContent":["import fs from 'fs/promises';\r\nimport path from 'path';\r\nimport { Redis } from '@upstash/redis';\r\n\r\nconst DB_PATH = path.join(process.cwd(), 'db.json');\r\n\r\nconst redis = (process.env.UPSTASH_REDIS_REST_URL && process.env.UPSTASH_REDIS_REST_TOKEN)\r\n    ? new Redis({\r\n        url: process.env.UPSTASH_REDIS_REST_URL,\r\n        token: process.env.UPSTASH_REDIS_REST_TOKEN,\r\n    })\r\n    : null;\r\n\r\nconst useCloud = () => !!redis;\r\n\r\nexport interface ImageRecord {\r\n    id: string;\r\n    telegram_file_id: string;\r\n    created_at: number;\r\n    views: number;\r\n    metadata: {\r\n        size: number;\r\n        type: string;\r\n    };\r\n}\r\n\r\nasync function ensureLocalDb() {\r\n    try {\r\n        await fs.access(DB_PATH);\r\n    } catch {\r\n        await fs.writeFile(DB_PATH, JSON.stringify({ images: [] }));\r\n    }\r\n}\r\n\r\nexport async function saveImage(record: any) {\r\n    if (useCloud() && redis) {\r\n        // Use HSET to store as a single Hash object in Redis\r\n        await redis.hset(`snap:${record.id}`, {\r\n            ...record,\r\n            views: 0,\r\n            metadata: JSON.stringify(record.metadata)\r\n        });\r\n        return;\r\n    }\r\n\r\n    await ensureLocalDb();\r\n    const content = await fs.readFile(DB_PATH, 'utf-8');\r\n    const db = JSON.parse(content);\r\n    db.images.push({ ...record, views: 0 });\r\n    await fs.writeFile(DB_PATH, JSON.stringify(db, null, 2));\r\n}\r\n\r\nexport async function getImage(id: string): Promise<ImageRecord | null> {\r\n    if (useCloud() && redis) {\r\n        // Increment views and get data from the SAME hash object\r\n        await redis.hincrby(`snap:${id}`, 'views', 1);\r\n        const data: any = await redis.hgetall(`snap:${id}`);\r\n\r\n        if (!data || Object.keys(data).length === 0) return null;\r\n\r\n        return {\r\n            ...data,\r\n            id,\r\n            views: parseInt(data.views || '0'),\r\n            created_at: parseInt(data.created_at),\r\n            metadata: typeof data.metadata === 'string' ? JSON.parse(data.metadata) : data.metadata\r\n        } as ImageRecord;\r\n    }\r\n\r\n    try {\r\n        await ensureLocalDb();\r\n        const content = await fs.readFile(DB_PATH, 'utf-8');\r\n        const db = JSON.parse(content);\r\n        const index = db.images.findIndex((img: any) => img.id === id);\r\n        if (index !== -1) {\r\n            db.images[index].views = (db.images[index].views || 0) + 1;\r\n            await fs.writeFile(DB_PATH, JSON.stringify(db, null, 2));\r\n            return db.images[index];\r\n        }\r\n        return null;\r\n    } catch {\r\n        return null;\r\n    }\r\n}\r\n\r\nexport function generateId() {\r\n    return Math.random().toString(36).substring(2, 10);\r\n}\r\n"],"names":[],"mappings":";;;;;;;;AAAA;AACA;AACA;;;;AAEA,MAAM,UAAU,4GAAI,CAAC,IAAI,CAAC,QAAQ,GAAG,IAAI;AAEzC,MAAM,QAAQ,AAAC,QAAQ,GAAG,CAAC,sBAAsB,IAAI,QAAQ,GAAG,CAAC,wBAAwB,GACnF,IAAI,wKAAK,CAAC;IACR,KAAK,QAAQ,GAAG,CAAC,sBAAsB;IACvC,OAAO,QAAQ,GAAG,CAAC,wBAAwB;AAC/C,KACE;AAEN,MAAM,WAAW,IAAM,CAAC,CAAC;AAazB,eAAe;IACX,IAAI;QACA,MAAM,gIAAE,CAAC,MAAM,CAAC;IACpB,EAAE,OAAM;QACJ,MAAM,gIAAE,CAAC,SAAS,CAAC,SAAS,KAAK,SAAS,CAAC;YAAE,QAAQ,EAAE;QAAC;IAC5D;AACJ;AAEO,eAAe,UAAU,MAAW;IACvC,IAAI,cAAc,OAAO;QACrB,qDAAqD;QACrD,MAAM,MAAM,IAAI,CAAC,CAAC,KAAK,EAAE,OAAO,EAAE,EAAE,EAAE;YAClC,GAAG,MAAM;YACT,OAAO;YACP,UAAU,KAAK,SAAS,CAAC,OAAO,QAAQ;QAC5C;QACA;IACJ;IAEA,MAAM;IACN,MAAM,UAAU,MAAM,gIAAE,CAAC,QAAQ,CAAC,SAAS;IAC3C,MAAM,KAAK,KAAK,KAAK,CAAC;IACtB,GAAG,MAAM,CAAC,IAAI,CAAC;QAAE,GAAG,MAAM;QAAE,OAAO;IAAE;IACrC,MAAM,gIAAE,CAAC,SAAS,CAAC,SAAS,KAAK,SAAS,CAAC,IAAI,MAAM;AACzD;AAEO,eAAe,SAAS,EAAU;IACrC,IAAI,cAAc,OAAO;QACrB,yDAAyD;QACzD,MAAM,MAAM,OAAO,CAAC,CAAC,KAAK,EAAE,IAAI,EAAE,SAAS;QAC3C,MAAM,OAAY,MAAM,MAAM,OAAO,CAAC,CAAC,KAAK,EAAE,IAAI;QAElD,IAAI,CAAC,QAAQ,OAAO,IAAI,CAAC,MAAM,MAAM,KAAK,GAAG,OAAO;QAEpD,OAAO;YACH,GAAG,IAAI;YACP;YACA,OAAO,SAAS,KAAK,KAAK,IAAI;YAC9B,YAAY,SAAS,KAAK,UAAU;YACpC,UAAU,OAAO,KAAK,QAAQ,KAAK,WAAW,KAAK,KAAK,CAAC,KAAK,QAAQ,IAAI,KAAK,QAAQ;QAC3F;IACJ;IAEA,IAAI;QACA,MAAM;QACN,MAAM,UAAU,MAAM,gIAAE,CAAC,QAAQ,CAAC,SAAS;QAC3C,MAAM,KAAK,KAAK,KAAK,CAAC;QACtB,MAAM,QAAQ,GAAG,MAAM,CAAC,SAAS,CAAC,CAAC,MAAa,IAAI,EAAE,KAAK;QAC3D,IAAI,UAAU,CAAC,GAAG;YACd,GAAG,MAAM,CAAC,MAAM,CAAC,KAAK,GAAG,CAAC,GAAG,MAAM,CAAC,MAAM,CAAC,KAAK,IAAI,CAAC,IAAI;YACzD,MAAM,gIAAE,CAAC,SAAS,CAAC,SAAS,KAAK,SAAS,CAAC,IAAI,MAAM;YACrD,OAAO,GAAG,MAAM,CAAC,MAAM;QAC3B;QACA,OAAO;IACX,EAAE,OAAM;QACJ,OAAO;IACX;AACJ;AAEO,SAAS;IACZ,OAAO,KAAK,MAAM,GAAG,QAAQ,CAAC,IAAI,SAAS,CAAC,GAAG;AACnD"}},
    {"offset": {"line": 148, "column": 0}, "map": {"version":3,"sources":["file:///F:/SnapEdge/src/lib/telegram.ts"],"sourcesContent":["export interface TelegramFileResult {\r\n  file_id: string;\r\n  file_unique_id: string;\r\n  file_path?: string;\r\n}\r\n\r\nexport async function uploadToTelegram(file: Blob, fileName: string): Promise<TelegramFileResult> {\r\n  const token = process.env.TELEGRAM_BOT_TOKEN;\r\n  const chatId = process.env.TELEGRAM_CHAT_ID;\r\n\r\n  if (!token || !chatId) {\r\n    throw new Error('Telegram credentials not configured');\r\n  }\r\n\r\n  const formData = new FormData();\r\n  formData.append('chat_id', chatId);\r\n  formData.append('photo', file, fileName);\r\n\r\n  const response = await fetch(`https://api.telegram.org/bot${token}/sendPhoto`, {\r\n    method: 'POST',\r\n    body: formData,\r\n  });\r\n\r\n  const data = await response.json();\r\n\r\n  if (!data.ok) {\r\n    throw new Error(`Telegram API error: ${data.description}`);\r\n  }\r\n\r\n  // Telegram returns an array of sizes, we take the largest one\r\n  const photos = data.result.photo;\r\n  const largestPhoto = photos[photos.length - 1];\r\n\r\n  return {\r\n    file_id: largestPhoto.file_id,\r\n    file_unique_id: largestPhoto.file_unique_id,\r\n  };\r\n}\r\n\r\nexport async function getTelegramFileUrl(fileId: string): Promise<string> {\r\n  const token = process.env.TELEGRAM_BOT_TOKEN;\r\n\r\n  if (!token) {\r\n    throw new Error('Telegram token not configured');\r\n  }\r\n\r\n  const response = await fetch(`https://api.telegram.org/bot${token}/getFile?file_id=${fileId}`);\r\n  const data = await response.json();\r\n\r\n  if (!data.ok) {\r\n    throw new Error(`Telegram API error: ${data.description}`);\r\n  }\r\n\r\n  const filePath = data.result.file_path;\r\n  return `https://api.telegram.org/file/bot${token}/${filePath}`;\r\n}\r\n"],"names":[],"mappings":";;;;;;AAMO,eAAe,iBAAiB,IAAU,EAAE,QAAgB;IACjE,MAAM,QAAQ,QAAQ,GAAG,CAAC,kBAAkB;IAC5C,MAAM,SAAS,QAAQ,GAAG,CAAC,gBAAgB;IAE3C,IAAI,CAAC,SAAS,CAAC,QAAQ;QACrB,MAAM,IAAI,MAAM;IAClB;IAEA,MAAM,WAAW,IAAI;IACrB,SAAS,MAAM,CAAC,WAAW;IAC3B,SAAS,MAAM,CAAC,SAAS,MAAM;IAE/B,MAAM,WAAW,MAAM,MAAM,CAAC,4BAA4B,EAAE,MAAM,UAAU,CAAC,EAAE;QAC7E,QAAQ;QACR,MAAM;IACR;IAEA,MAAM,OAAO,MAAM,SAAS,IAAI;IAEhC,IAAI,CAAC,KAAK,EAAE,EAAE;QACZ,MAAM,IAAI,MAAM,CAAC,oBAAoB,EAAE,KAAK,WAAW,EAAE;IAC3D;IAEA,8DAA8D;IAC9D,MAAM,SAAS,KAAK,MAAM,CAAC,KAAK;IAChC,MAAM,eAAe,MAAM,CAAC,OAAO,MAAM,GAAG,EAAE;IAE9C,OAAO;QACL,SAAS,aAAa,OAAO;QAC7B,gBAAgB,aAAa,cAAc;IAC7C;AACF;AAEO,eAAe,mBAAmB,MAAc;IACrD,MAAM,QAAQ,QAAQ,GAAG,CAAC,kBAAkB;IAE5C,IAAI,CAAC,OAAO;QACV,MAAM,IAAI,MAAM;IAClB;IAEA,MAAM,WAAW,MAAM,MAAM,CAAC,4BAA4B,EAAE,MAAM,iBAAiB,EAAE,QAAQ;IAC7F,MAAM,OAAO,MAAM,SAAS,IAAI;IAEhC,IAAI,CAAC,KAAK,EAAE,EAAE;QACZ,MAAM,IAAI,MAAM,CAAC,oBAAoB,EAAE,KAAK,WAAW,EAAE;IAC3D;IAEA,MAAM,WAAW,KAAK,MAAM,CAAC,SAAS;IACtC,OAAO,CAAC,iCAAiC,EAAE,MAAM,CAAC,EAAE,UAAU;AAChE"}},
    {"offset": {"line": 196, "column": 0}, "map": {"version":3,"sources":["file:///F:/SnapEdge/src/app/i/%5Bid%5D/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport { getImage } from '@/lib/db';\r\nimport { getTelegramFileUrl } from '@/lib/telegram';\r\n\r\nexport const runtime = 'nodejs';\r\n\r\nexport async function GET(\r\n    req: NextRequest,\r\n    { params }: { params: Promise<{ id: string }> }\r\n) {\r\n    const { id: rawId } = await params;\r\n\r\n    const hasExtension = rawId.includes('.');\r\n    const id = hasExtension ? rawId.split('.')[0] : rawId;\r\n\r\n    try {\r\n        const record = await getImage(id);\r\n\r\n        if (!record) {\r\n            return new NextResponse('Image not found', { status: 404 });\r\n        }\r\n\r\n        const fileUrl = await getTelegramFileUrl(record.telegram_file_id);\r\n\r\n        const proxyImage = async () => {\r\n            const response = await fetch(fileUrl);\r\n            const blob = await response.blob();\r\n            const headers = new Headers();\r\n            headers.set('Content-Type', response.headers.get('Content-Type') || 'image/jpeg');\r\n            headers.set('Cache-Control', 'public, max-age=31536000, immutable');\r\n            return new NextResponse(blob, { headers });\r\n        };\r\n\r\n        const accept = req.headers.get('accept') || '';\r\n        if (hasExtension || !accept.includes('text/html')) {\r\n            return proxyImage();\r\n        }\r\n\r\n        const proxiedImgSrc = `/i/${id}.jpg`;\r\n        const views = record.views || 0;\r\n        const formattedDate = new Date(record.created_at).toLocaleDateString();\r\n        const formattedSize = record.metadata?.size ? (record.metadata.size / 1024 / 1024).toFixed(2) + ' MB' : 'Unknown';\r\n\r\n        return new NextResponse(\r\n            `<!DOCTYPE html>\r\n            <html lang=\"en\">\r\n            <head>\r\n                <meta charset=\"UTF-8\">\r\n                <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n                <title>SnapEdge | ${id}</title>\r\n                <meta property=\"og:title\" content=\"SnapEdge Image\">\r\n                <meta property=\"og:image\" content=\"${proxiedImgSrc}\">\r\n                <meta name=\"twitter:card\" content=\"summary_large_image\">\r\n                <style>\r\n                    body { margin: 0; background: #050505; color: white; font-family: 'Inter', system-ui, -apple-system, sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; overflow: hidden; }\r\n                    .container { position: relative; max-width: 90vw; max-height: 80vh; display: flex; align-items: center; justify-content: center; }\r\n                    img { max-width: 100%; max-height: 80vh; border-radius: 12px; box-shadow: 0 30px 60px rgba(0,0,0,0.8); border: 1px solid rgba(255,255,255,0.1); }\r\n                    .toolbar { \r\n                        position: fixed; \r\n                        top: 20px; \r\n                        left: 50%; \r\n                        transform: translateX(-50%); \r\n                        display: flex; \r\n                        gap: 15px; \r\n                        background: rgba(20, 20, 20, 0.7); \r\n                        backdrop-filter: blur(10px); \r\n                        -webkit-backdrop-filter: blur(10px);\r\n                        padding: 10px 20px; \r\n                        border-radius: 100px; \r\n                        border: 1px solid rgba(255,255,255,0.1);\r\n                        z-index: 100;\r\n                    }\r\n                    .info-bar {\r\n                        position: fixed;\r\n                        bottom: 30px;\r\n                        background: rgba(255, 255, 255, 0.05);\r\n                        backdrop-filter: blur(10px);\r\n                        padding: 12px 24px;\r\n                        border-radius: 16px;\r\n                        display: flex;\r\n                        gap: 30px;\r\n                        font-size: 13px;\r\n                        color: #a1a1aa;\r\n                        border: 1px solid rgba(255,255,255,0.05);\r\n                    }\r\n                    .info-item b { color: white; margin-right: 5px; }\r\n                    a { \r\n                        color: #ffffff; \r\n                        text-decoration: none; \r\n                        font-size: 14px; \r\n                        font-weight: 500;\r\n                        padding: 8px 16px; \r\n                        border-radius: 50px; \r\n                        transition: all 0.2s ease;\r\n                        display: flex;\r\n                        align-items: center;\r\n                        gap: 6px;\r\n                    }\r\n                    a.primary { background: #8b5cf6; color: white; }\r\n                    a.primary:hover { background: #7c3aed; }\r\n                    a.secondary { background: rgba(255,255,255,0.1); color: #a1a1aa; }\r\n                    a.secondary:hover { background: rgba(255,255,255,0.2); color: white; }\r\n                </style>\r\n            </head>\r\n            <body>\r\n                <div class=\"toolbar\">\r\n                    <a href=\"/\" class=\"secondary\">Upload New</a>\r\n                    <a href=\"${proxiedImgSrc}\" download class=\"primary\">Download Raw</a>\r\n                </div>\r\n                <div class=\"container\">\r\n                    <img src=\"${proxiedImgSrc}\" alt=\"SnapEdge Image\">\r\n                </div>\r\n                <div class=\"info-bar\">\r\n                    <div class=\"info-item\"><b>Views</b> ${views}</div>\r\n                    <div class=\"info-item\"><b>Size</b> ${formattedSize}</div>\r\n                    <div class=\"info-item\"><b>Date</b> ${formattedDate}</div>\r\n                </div>\r\n            </body>\r\n            </html>`,\r\n            {\r\n                headers: { 'Content-Type': 'text/html' },\r\n            }\r\n        );\r\n    } catch (error) {\r\n        console.error('Redirection error:', error);\r\n        return new NextResponse('Internal server error', { status: 500 });\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;;;AAAA;AACA;AACA;;;;AAEO,MAAM,UAAU;AAEhB,eAAe,IAClB,GAAgB,EAChB,EAAE,MAAM,EAAuC;IAE/C,MAAM,EAAE,IAAI,KAAK,EAAE,GAAG,MAAM;IAE5B,MAAM,eAAe,MAAM,QAAQ,CAAC;IACpC,MAAM,KAAK,eAAe,MAAM,KAAK,CAAC,IAAI,CAAC,EAAE,GAAG;IAEhD,IAAI;QACA,MAAM,SAAS,MAAM,IAAA,8HAAQ,EAAC;QAE9B,IAAI,CAAC,QAAQ;YACT,OAAO,IAAI,gJAAY,CAAC,mBAAmB;gBAAE,QAAQ;YAAI;QAC7D;QAEA,MAAM,UAAU,MAAM,IAAA,8IAAkB,EAAC,OAAO,gBAAgB;QAEhE,MAAM,aAAa;YACf,MAAM,WAAW,MAAM,MAAM;YAC7B,MAAM,OAAO,MAAM,SAAS,IAAI;YAChC,MAAM,UAAU,IAAI;YACpB,QAAQ,GAAG,CAAC,gBAAgB,SAAS,OAAO,CAAC,GAAG,CAAC,mBAAmB;YACpE,QAAQ,GAAG,CAAC,iBAAiB;YAC7B,OAAO,IAAI,gJAAY,CAAC,MAAM;gBAAE;YAAQ;QAC5C;QAEA,MAAM,SAAS,IAAI,OAAO,CAAC,GAAG,CAAC,aAAa;QAC5C,IAAI,gBAAgB,CAAC,OAAO,QAAQ,CAAC,cAAc;YAC/C,OAAO;QACX;QAEA,MAAM,gBAAgB,CAAC,GAAG,EAAE,GAAG,IAAI,CAAC;QACpC,MAAM,QAAQ,OAAO,KAAK,IAAI;QAC9B,MAAM,gBAAgB,IAAI,KAAK,OAAO,UAAU,EAAE,kBAAkB;QACpE,MAAM,gBAAgB,OAAO,QAAQ,EAAE,OAAO,CAAC,OAAO,QAAQ,CAAC,IAAI,GAAG,OAAO,IAAI,EAAE,OAAO,CAAC,KAAK,QAAQ;QAExG,OAAO,IAAI,gJAAY,CACnB,CAAC;;;;;kCAKqB,EAAE,GAAG;;mDAEY,EAAE,cAAc;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;6BAwDtC,EAAE,cAAc;;;8BAGf,EAAE,cAAc;;;wDAGU,EAAE,MAAM;uDACT,EAAE,cAAc;uDAChB,EAAE,cAAc;;;mBAGpD,CAAC,EACR;YACI,SAAS;gBAAE,gBAAgB;YAAY;QAC3C;IAER,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,sBAAsB;QACpC,OAAO,IAAI,gJAAY,CAAC,yBAAyB;YAAE,QAAQ;QAAI;IACnE;AACJ"}}]
}