{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///F:/SnapEdge/src/lib/db.ts"],"sourcesContent":["import fs from 'fs/promises';\r\nimport path from 'path';\r\n\r\nconst DB_PATH = path.join(process.cwd(), 'db.json');\r\n\r\nexport interface ImageRecord {\r\n    id: string; // Clean ID used in URL\r\n    telegram_file_id: string;\r\n    created_at: number;\r\n}\r\n\r\nasync function ensureDb() {\r\n    try {\r\n        await fs.access(DB_PATH);\r\n    } catch {\r\n        await fs.writeFile(DB_PATH, JSON.stringify({ images: [] }));\r\n    }\r\n}\r\n\r\nexport async function saveImage(record: ImageRecord) {\r\n    await ensureDb();\r\n    const content = await fs.readFile(DB_PATH, 'utf-8');\r\n    const db = JSON.parse(content);\r\n    db.images.push(record);\r\n    await fs.writeFile(DB_PATH, JSON.stringify(db, null, 2));\r\n}\r\n\r\nexport async function getImage(id: string): Promise<ImageRecord | null> {\r\n    await ensureDb();\r\n    const content = await fs.readFile(DB_PATH, 'utf-8');\r\n    const db = JSON.parse(content);\r\n    return db.images.find((img: ImageRecord) => img.id === id) || null;\r\n}\r\n\r\nexport function generateId() {\r\n    return Math.random().toString(36).substring(2, 10);\r\n}\r\n"],"names":[],"mappings":";;;;;;;;AAAA;AACA;;;AAEA,MAAM,UAAU,4GAAI,CAAC,IAAI,CAAC,QAAQ,GAAG,IAAI;AAQzC,eAAe;IACX,IAAI;QACA,MAAM,gIAAE,CAAC,MAAM,CAAC;IACpB,EAAE,OAAM;QACJ,MAAM,gIAAE,CAAC,SAAS,CAAC,SAAS,KAAK,SAAS,CAAC;YAAE,QAAQ,EAAE;QAAC;IAC5D;AACJ;AAEO,eAAe,UAAU,MAAmB;IAC/C,MAAM;IACN,MAAM,UAAU,MAAM,gIAAE,CAAC,QAAQ,CAAC,SAAS;IAC3C,MAAM,KAAK,KAAK,KAAK,CAAC;IACtB,GAAG,MAAM,CAAC,IAAI,CAAC;IACf,MAAM,gIAAE,CAAC,SAAS,CAAC,SAAS,KAAK,SAAS,CAAC,IAAI,MAAM;AACzD;AAEO,eAAe,SAAS,EAAU;IACrC,MAAM;IACN,MAAM,UAAU,MAAM,gIAAE,CAAC,QAAQ,CAAC,SAAS;IAC3C,MAAM,KAAK,KAAK,KAAK,CAAC;IACtB,OAAO,GAAG,MAAM,CAAC,IAAI,CAAC,CAAC,MAAqB,IAAI,EAAE,KAAK,OAAO;AAClE;AAEO,SAAS;IACZ,OAAO,KAAK,MAAM,GAAG,QAAQ,CAAC,IAAI,SAAS,CAAC,GAAG;AACnD"}},
    {"offset": {"line": 100, "column": 0}, "map": {"version":3,"sources":["file:///F:/SnapEdge/src/lib/telegram.ts"],"sourcesContent":["export interface TelegramFileResult {\r\n  file_id: string;\r\n  file_unique_id: string;\r\n  file_path?: string;\r\n}\r\n\r\nexport async function uploadToTelegram(file: Blob, fileName: string): Promise<TelegramFileResult> {\r\n  const token = process.env.TELEGRAM_BOT_TOKEN;\r\n  const chatId = process.env.TELEGRAM_CHAT_ID;\r\n\r\n  if (!token || !chatId) {\r\n    throw new Error('Telegram credentials not configured');\r\n  }\r\n\r\n  const formData = new FormData();\r\n  formData.append('chat_id', chatId);\r\n  formData.append('photo', file, fileName);\r\n\r\n  const response = await fetch(`https://api.telegram.org/bot${token}/sendPhoto`, {\r\n    method: 'POST',\r\n    body: formData,\r\n  });\r\n\r\n  const data = await response.json();\r\n\r\n  if (!data.ok) {\r\n    throw new Error(`Telegram API error: ${data.description}`);\r\n  }\r\n\r\n  // Telegram returns an array of sizes, we take the largest one\r\n  const photos = data.result.photo;\r\n  const largestPhoto = photos[photos.length - 1];\r\n\r\n  return {\r\n    file_id: largestPhoto.file_id,\r\n    file_unique_id: largestPhoto.file_unique_id,\r\n  };\r\n}\r\n\r\nexport async function getTelegramFileUrl(fileId: string): Promise<string> {\r\n  const token = process.env.TELEGRAM_BOT_TOKEN;\r\n\r\n  if (!token) {\r\n    throw new Error('Telegram token not configured');\r\n  }\r\n\r\n  const response = await fetch(`https://api.telegram.org/bot${token}/getFile?file_id=${fileId}`);\r\n  const data = await response.json();\r\n\r\n  if (!data.ok) {\r\n    throw new Error(`Telegram API error: ${data.description}`);\r\n  }\r\n\r\n  const filePath = data.result.file_path;\r\n  return `https://api.telegram.org/file/bot${token}/${filePath}`;\r\n}\r\n"],"names":[],"mappings":";;;;;;AAMO,eAAe,iBAAiB,IAAU,EAAE,QAAgB;IACjE,MAAM,QAAQ,QAAQ,GAAG,CAAC,kBAAkB;IAC5C,MAAM,SAAS,QAAQ,GAAG,CAAC,gBAAgB;IAE3C,IAAI,CAAC,SAAS,CAAC,QAAQ;QACrB,MAAM,IAAI,MAAM;IAClB;IAEA,MAAM,WAAW,IAAI;IACrB,SAAS,MAAM,CAAC,WAAW;IAC3B,SAAS,MAAM,CAAC,SAAS,MAAM;IAE/B,MAAM,WAAW,MAAM,MAAM,CAAC,4BAA4B,EAAE,MAAM,UAAU,CAAC,EAAE;QAC7E,QAAQ;QACR,MAAM;IACR;IAEA,MAAM,OAAO,MAAM,SAAS,IAAI;IAEhC,IAAI,CAAC,KAAK,EAAE,EAAE;QACZ,MAAM,IAAI,MAAM,CAAC,oBAAoB,EAAE,KAAK,WAAW,EAAE;IAC3D;IAEA,8DAA8D;IAC9D,MAAM,SAAS,KAAK,MAAM,CAAC,KAAK;IAChC,MAAM,eAAe,MAAM,CAAC,OAAO,MAAM,GAAG,EAAE;IAE9C,OAAO;QACL,SAAS,aAAa,OAAO;QAC7B,gBAAgB,aAAa,cAAc;IAC7C;AACF;AAEO,eAAe,mBAAmB,MAAc;IACrD,MAAM,QAAQ,QAAQ,GAAG,CAAC,kBAAkB;IAE5C,IAAI,CAAC,OAAO;QACV,MAAM,IAAI,MAAM;IAClB;IAEA,MAAM,WAAW,MAAM,MAAM,CAAC,4BAA4B,EAAE,MAAM,iBAAiB,EAAE,QAAQ;IAC7F,MAAM,OAAO,MAAM,SAAS,IAAI;IAEhC,IAAI,CAAC,KAAK,EAAE,EAAE;QACZ,MAAM,IAAI,MAAM,CAAC,oBAAoB,EAAE,KAAK,WAAW,EAAE;IAC3D;IAEA,MAAM,WAAW,KAAK,MAAM,CAAC,SAAS;IACtC,OAAO,CAAC,iCAAiC,EAAE,MAAM,CAAC,EAAE,UAAU;AAChE"}},
    {"offset": {"line": 148, "column": 0}, "map": {"version":3,"sources":["file:///F:/SnapEdge/src/app/i/%5Bid%5D/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport { getImage } from '@/lib/db';\r\nimport { getTelegramFileUrl } from '@/lib/telegram';\r\n\r\nexport const runtime = 'nodejs'; // Using nodejs for now because of fs in lib/db\r\n\r\nexport async function GET(\r\n    req: NextRequest,\r\n    { params }: { params: Promise<{ id: string }> }\r\n) {\r\n    const { id: rawId } = await params;\r\n\r\n    // Support for both direct file access (e.g. /i/abc.jpg) and viewer (e.g. /i/abc)\r\n    const hasExtension = rawId.includes('.');\r\n    const id = hasExtension ? rawId.split('.')[0] : rawId;\r\n\r\n    try {\r\n        const record = await getImage(id);\r\n\r\n        if (!record) {\r\n            return new NextResponse('Image not found', { status: 404 });\r\n        }\r\n\r\n        const fileUrl = await getTelegramFileUrl(record.telegram_file_id);\r\n\r\n        // SECURITY FIX: Proxy the image instead of redirecting to Telegram\r\n        // This keeps your TELEGRAM_BOT_TOKEN hidden from the user's browser\r\n        const proxyImage = async () => {\r\n            const response = await fetch(fileUrl);\r\n            const blob = await response.blob();\r\n            const headers = new Headers();\r\n            headers.set('Content-Type', response.headers.get('Content-Type') || 'image/jpeg');\r\n            headers.set('Cache-Control', 'public, max-age=31536000, immutable');\r\n            return new NextResponse(blob, { headers });\r\n        };\r\n\r\n        const accept = req.headers.get('accept') || '';\r\n        if (hasExtension || !accept.includes('text/html')) {\r\n            return proxyImage();\r\n        }\r\n\r\n        // Otherwise, serve a premium minimalist viewer page\r\n        // Note: the <img> tag now points to the same route with an extension to trigger the proxy\r\n        const proxiedImgSrc = `/i/${id}.jpg`;\r\n\r\n        return new NextResponse(\r\n            `<!DOCTYPE html>\r\n            <html lang=\"en\">\r\n            <head>\r\n                <meta charset=\"UTF-8\">\r\n                <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n                <title>SnapEdge | Image View</title>\r\n                <meta property=\"og:title\" content=\"SnapEdge Image\">\r\n                <meta property=\"og:image\" content=\"${proxiedImgSrc}\">\r\n                <meta name=\"twitter:card\" content=\"summary_large_image\">\r\n                <style>\r\n                    body { margin: 0; background: #050505; color: white; font-family: 'Inter', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; overflow: hidden; }\r\n                    .container { position: relative; max-width: 90vw; max-height: 85vh; display: flex; align-items: center; justify-content: center; }\r\n                    img { max-width: 100%; max-height: 85vh; border-radius: 12px; box-shadow: 0 30px 60px rgba(0,0,0,0.8); border: 1px solid rgba(255,255,255,0.1); }\r\n                    .toolbar { \r\n                        position: fixed; \r\n                        top: 20px; \r\n                        left: 50%; \r\n                        transform: translateX(-50%); \r\n                        display: flex; \r\n                        gap: 15px; \r\n                        background: rgba(20, 20, 20, 0.7); \r\n                        backdrop-filter: blur(10px); \r\n                        -webkit-backdrop-filter: blur(10px);\r\n                        padding: 10px 20px; \r\n                        border-radius: 100px; \r\n                        border: 1px solid rgba(255,255,255,0.1);\r\n                        z-index: 100;\r\n                        box-shadow: 0 10px 30px rgba(0,0,0,0.5);\r\n                    }\r\n                    a { \r\n                        color: #ffffff; \r\n                        text-decoration: none; \r\n                        font-size: 14px; \r\n                        font-weight: 500;\r\n                        padding: 8px 16px; \r\n                        border-radius: 50px; \r\n                        transition: all 0.2s ease;\r\n                        display: flex;\r\n                        align-items: center;\r\n                        gap: 6px;\r\n                    }\r\n                    a.primary { background: #8b5cf6; color: white; }\r\n                    a.primary:hover { background: #7c3aed; transform: translateY(-1px); }\r\n                    a.secondary { background: rgba(255,255,255,0.1); color: #a1a1aa; }\r\n                    a.secondary:hover { background: rgba(255,255,255,0.2); color: white; }\r\n                </style>\r\n            </head>\r\n            <body>\r\n                <div class=\"toolbar\">\r\n                    <a href=\"/\" class=\"secondary\">\r\n                        <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4\"></path><polyline points=\"17 8 12 3 7 8\"></polyline><line x1=\"12\" y1=\"3\" x2=\"12\" y2=\"15\"></line></svg>\r\n                        Upload New\r\n                    </a>\r\n                    <a href=\"${proxiedImgSrc}\" download class=\"primary\">\r\n                        <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4\"></path><polyline points=\"7 10 12 15 17 10\"></polyline><line x1=\"12\" y1=\"15\" x2=\"12\" y2=\"3\"></line></svg>\r\n                        Download Raw\r\n                    </a>\r\n                </div>\r\n                <div class=\"container\">\r\n                    <img src=\"${proxiedImgSrc}\" alt=\"SnapEdge Image\">\r\n                </div>\r\n            </body>\r\n            </html>`,\r\n            {\r\n                headers: { 'Content-Type': 'text/html' },\r\n            }\r\n        );\r\n    } catch (error) {\r\n        console.error('Redirection error:', error);\r\n        return new NextResponse('Internal server error', { status: 500 });\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;;;AAAA;AACA;AACA;;;;AAEO,MAAM,UAAU,UAAU,+CAA+C;AAEzE,eAAe,IAClB,GAAgB,EAChB,EAAE,MAAM,EAAuC;IAE/C,MAAM,EAAE,IAAI,KAAK,EAAE,GAAG,MAAM;IAE5B,iFAAiF;IACjF,MAAM,eAAe,MAAM,QAAQ,CAAC;IACpC,MAAM,KAAK,eAAe,MAAM,KAAK,CAAC,IAAI,CAAC,EAAE,GAAG;IAEhD,IAAI;QACA,MAAM,SAAS,MAAM,IAAA,8HAAQ,EAAC;QAE9B,IAAI,CAAC,QAAQ;YACT,OAAO,IAAI,gJAAY,CAAC,mBAAmB;gBAAE,QAAQ;YAAI;QAC7D;QAEA,MAAM,UAAU,MAAM,IAAA,8IAAkB,EAAC,OAAO,gBAAgB;QAEhE,mEAAmE;QACnE,oEAAoE;QACpE,MAAM,aAAa;YACf,MAAM,WAAW,MAAM,MAAM;YAC7B,MAAM,OAAO,MAAM,SAAS,IAAI;YAChC,MAAM,UAAU,IAAI;YACpB,QAAQ,GAAG,CAAC,gBAAgB,SAAS,OAAO,CAAC,GAAG,CAAC,mBAAmB;YACpE,QAAQ,GAAG,CAAC,iBAAiB;YAC7B,OAAO,IAAI,gJAAY,CAAC,MAAM;gBAAE;YAAQ;QAC5C;QAEA,MAAM,SAAS,IAAI,OAAO,CAAC,GAAG,CAAC,aAAa;QAC5C,IAAI,gBAAgB,CAAC,OAAO,QAAQ,CAAC,cAAc;YAC/C,OAAO;QACX;QAEA,oDAAoD;QACpD,0FAA0F;QAC1F,MAAM,gBAAgB,CAAC,GAAG,EAAE,GAAG,IAAI,CAAC;QAEpC,OAAO,IAAI,gJAAY,CACnB,CAAC;;;;;;;mDAOsC,EAAE,cAAc;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;6BA8CtC,EAAE,cAAc;;;;;;8BAMf,EAAE,cAAc;;;mBAG3B,CAAC,EACR;YACI,SAAS;gBAAE,gBAAgB;YAAY;QAC3C;IAER,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,sBAAsB;QACpC,OAAO,IAAI,gJAAY,CAAC,yBAAyB;YAAE,QAAQ;QAAI;IACnE;AACJ"}}]
}